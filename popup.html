<!DOCTYPE>
<html lang="pt-br">
    <head><title>eScanner</title><link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8"/></head>
    <body>
		<div id="all">
			<div class="backmenu">
				<div class="navigation">
					<ul class="menu" id="menu">
						<li><a class="ativa" href="#">Resultados</a></li>
						<li><a href="sobre_emag.html">Sobre o e-MAG</a></li>
						<li><a href="tutoriais.html">Tutoriais</a></li>
						<li><a href="ajuda.html">Ajuda</a></li>
					</ul>
				</div>
			</div>
			<div class="container">
				<div class="mensagens">
					<div id="titulo">
						<h2>Resultado do Escaneamento</h2>
					</div>
					<div id="resumo">
						<ul>
							<li><a href="#erros">0 erros</a></li>
							<li><a href="#alertas">0 alertas</a></li>
						</ul>
					</div>
					
					<div class="item">
						<br/>
						<center><img src="images/loading.gif" alt="Carregando" />
						<p>Analisando página atual</p></center>
					</div>
					
					<div class="item tituloEr" id="erros" name="erros">
						<h3>Erros</h3>	
					</div>
					<div class="grupoErros"></div>
					
					<div class="item tituloAl" id="alertas" name="alertas">
						<h3>Alertas</h3>	
					</div>
					<div class="grupoAlertas"></div>					
				</div>
			</div>
		</div>
		
		<script type="text/javascript" src="js/jquery-1.3.2.js"></script>
		<script src="js/htmlparser.js"></script>
        <script type="text/javascript">
			var xmlhttp = new XMLHttpRequest();
			var erros = new Array();
			var html, contEr = 0, contAl = 0,success = 0;
			
			$(".container").css("overflow-y","scroll");
			$("#resumo ul, #erros, #alertas").hide();
			
			function formataLinhas(ocorrencia, linha){
			
				var num = linha.lastIndexOf(",");
				linha = linha.slice(0,num).concat(".");
				
				if(ocorrencia > 1){
					num = linha.lastIndexOf(",");
					num2 = linha.lastIndexOf(".");
					st = linha.slice(0,num).concat(" e");
					linha = st.concat(linha.slice(num+1,num2+1));
				}
				else if(ocorrencia == 1){
					linha = linha.replace("nas linhas","na linha");
				}
				
				return linha;
			}
			
			function alteraURL(url){
			
				xmlhttp.open("POST", url, true);
				
				xmlhttp.onreadystatechange = function(){
				
					if (xmlhttp.readyState==4){
					
						if ((xmlhttp.status == 200)||(xmlhttp.status == 304)) {
							html = xmlhttp.responseText;
							if((html=="")||(html.match(/^\D+$/))){
								$("img[alt='Carregando']").hide();
								$(".item:first").html("<p>Que estranho...<br/>Não foi possível capturar o código fonte desta página. =(</p><p>Tente outra vez ou teste outra página.</p>");
							}else{							
								erros = ValidaHTML(html);
								
								for ( var i = 0; i < erros.length; i++ ){								
									if((erros[i].tipo == 0)&&(erros[i].ocorrencia > 0)){
										contEr++;
										erros[i].linha = formataLinhas(erros[i].ocorrencia, erros[i].linha);
										$(".grupoErros").append("<div class='item erro'><a href='#'></a><p>"+ erros[i].descricao + "" + erros[i].linha +"</p><div class='detalhes'>" + erros[i].detalhe +"</div></div>");
									
									}
									else if((erros[i].tipo == 1)&&(erros[i].ocorrencia > 0)){
										contAl++;
										$(".grupoAlertas").append("<div class='item alerta'><a href='#'></a><p>"+ erros[i].descricao + "</p><div class='detalhes'>" + erros[i].detalhe +"</div></div>");
									
									}
								}
								
								$("img[alt='Carregando']").hide();
								$(".detalhes").hide();
								
								if(contEr == 1){
									$(".item:first").html("<p>Foi identificado <b>" + contEr + " erro no seu código de acordo as recomendações do<br/> e-MAG.</p><p>Verifique os alertas, pois são recomendações que dependem da avaliação do programador.</p>"); 
									$("#resumo ul li a:first").html(contEr + " erro"); 							
								
								} else if(contEr > 1){
									$(".item:first").html("<p>Foram identificados <b>" + contEr + " erros no seu código de acordo as recomendações do e-MAG.</p><p>Verifique os alertas, pois são recomendações que dependem da avaliação do programador.</p>"); 
									$("#resumo ul li a:first").html(contEr + " erros"); 							
								
								} else{
									$(".item:first").html("<p>Não foram identificados erros no seu código de acordo as recomendações do e-MAG, em sua versão 3.0. <br/>Para uma análise mais detalhada utilize o validador <a href='http://www.dasilva.org.br/'>daSilva</a><br/>ou o <a href='http://www.governoeletronico.gov.br/acoes-e-projetos/e-MAG/ases-avaliador-e-simulador-de-acessibilidade-sitios'>Avaliador e Simulador de Acessibilidade de Sítios - ASES</a>.</p><p>Não deixe de verificar os alertas, pois são recomendações que dependem da avaliação do programador.</p>"); 
									$("#resumo ul li a:first").html(contEr + " erros"); 							
								}
								
								if(contAl == 1){
									$("#resumo ul li a:last").html(contAl + " alerta"); 
								
								}else{
									$("#resumo ul li a:last").html(contAl + " alertas"); 
								}
								
								$("#resumo ul").fadeIn();
								if (contEr > 0) $("#erros").show();
								if (contAl > 0) $("#alertas").show();
								
								$(".grupoErros a, .grupoAlertas a").toggle(
									function(){
										$(this).parent().find(".detalhes").slideDown();
										$(this).css("background","url(images/minus.png)");
									},
									function(){
										$(this).parent().find(".detalhes").slideUp();
										$(this).css("background","url(images/plus.png)");
									}
								);
								
								$("div.item:first a").css({"text-decoration":"underline","color":"blue"});
								$("div.item:first a:first").click(function(){
									chrome.tabs.create({'url': 'http://www.dasilva.org.br/'}, function(tab){ });
								});
								$("div.item:first a:last").click(function(){
									chrome.tabs.create({'url': 'http://www.governoeletronico.gov.br/acoes-e-projetos/e-MAG/ases-avaliador-e-simulador-de-acessibilidade-sitios/'}, function(tab){ });
								});
							}	
						}
						else{
							$("img[alt='Carregando']").hide();
							$(".item:first").html("<p>Que estranho...<br/>Não foi possível capturar o código fonte desta página. =(</p><p>Tente outra vez ou teste outra página.</p>");
						}
						success = 1;
					}
					window.setTimeout(function() {
						if (!success){					
							$("img[alt='Carregando']").hide();
							$(".item:first").html("<p>Desculpe, o eScanner não conseguiu terminar sua análise.<br/> O servidor não respondeu a requisição ou existe algum elemento que não faz parte da sintaxe padrão do XHTML.</p><p>Verifique seu código fonte e o servidor e tente outra vez.</p>");
						}
					}, 3000); 
					
				}	
				xmlhttp.send(null);
			}
			
			chrome.tabs.getSelected(null, function(tab) {
				alteraURL(tab.url);
			});
        </script>
		<noscript>
			<p>O JavaScript não está funcionando, você pode ter problemas ao utilizar esta página.</p>
		</noscript>
    </body>
</html>